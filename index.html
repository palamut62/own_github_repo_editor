<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Repo Editor</title>
    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #1e1e1e;
            /* Darker DodoHub-like background */
            --bg-sidebar: #252526;
            /* Slightly lighter sidebar */
            --bg-card: #2d2d30;
            /* Card background */
            --bg-input: #3e3e42;
            --border-color: #454545;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --accent-green: #3fb950;
            --accent-yellow: #d29922;
            --accent-blue: #58a6ff;
            --danger: #f85149;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            overflow: hidden;
            display: flex;
            height: 100vh;
            user-select: none;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 250px;
            background-color: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            padding-top: 40px;
            /* Space for Traffic Lights */
            flex-shrink: 0;
            position: relative;
        }

        .traffic-lights {
            position: fixed;
            top: 15px;
            left: 15px;
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
            /* Buttons clickable */
            z-index: 1000;
        }

        .drag-region {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            -webkit-app-region: drag;
            z-index: 999;
        }

        .control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }

        .btn-close {
            background: #ff5f56;
        }

        .btn-minimize {
            background: #ffbd2e;
        }

        .btn-maximize {
            background: #27c93f;
        }

        .control-btn:hover {
            filter: brightness(0.8);
        }

        .nav-group {
            padding: 20px;
        }

        .nav-title {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 700;
            margin-bottom: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .nav-item:hover,
        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            position: absolute;
            bottom: 0;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--bg-sidebar);
            /* Ensure opacity */
        }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-body);
        }

        .header {
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            -webkit-app-region: drag;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            -webkit-app-region: no-drag;
        }

        .page-title {
            font-size: 20px;
            font-weight: 700;
        }

        .search-bar {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }

        .input-dark {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-family: inherit;
            outline: none;
            font-size: 13px;
        }

        .btn-primary {
            background: var(--accent-green);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-dark {
            background: var(--bg-input);
            color: white;
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* --- Grid Layout --- */
        .repo-grid {
            padding: 0 30px 30px 30px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
            overflow-y: auto;
            flex: 1;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        .repo-card {
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            border: 1px solid transparent;
        }

        .repo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            border-color: var(--border-color);
        }

        .repo-card.selected {
            border: 1px solid var(--accent-blue);
            background-color: rgba(88, 166, 255, 0.1);
        }

        .card-header {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .repo-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: cover;
        }

        .repo-details {
            flex: 1;
            overflow: hidden;
        }

        .card-title {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .card-desc {
            font-size: 13px;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: auto;
            margin-bottom: 4px;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: auto;
        }

        .badge {
            font-size: 11px;
            font-weight: 500;
            padding: 0;
            background: transparent !important;
        }

        .badge-source {
            color: var(--accent-green);
        }

        .badge-fork {
            color: var(--accent-blue);
        }

        .badge-star {
            color: var(--accent-yellow);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .card-check {
            position: absolute;
            top: 20px;
            right: 20px;
            transform: scale(1.2);
            accent-color: var(--accent-blue);
            cursor: pointer;
        }

        /* --- List View Overrides --- */
        .repo-grid.list-view {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .repo-grid.list-view .repo-card {
            flex-direction: row;
            align-items: center;
            padding: 12px 20px;
        }

        .repo-grid.list-view .card-header {
            width: 300px;
            margin-right: 20px;
            align-items: center;
        }

        .repo-grid.list-view .card-desc {
            flex: 1;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            min-height: auto;
            margin-bottom: 0;
            padding-right: 20px;
        }

        .repo-grid.list-view .card-meta {
            width: 150px;
            margin-top: 0;
            justify-content: flex-end;
            gap: 15px;
        }

        .repo-grid.list-view .card-check {
            position: static;
            transform: scale(1.1);
            margin-right: 15px;
        }

        /* --- Footer --- */
        .footer-controls {
            padding: 15px 30px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-body);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Modals (Reuse existing styles mostly) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-box {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .auth-input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <!-- Window Drag Region -->
    <div class="drag-region"></div>
    <div class="traffic-lights">
        <button class="control-btn btn-close" onclick="window.api.close()"></button>
        <button class="control-btn btn-minimize" onclick="window.api.minimize()"></button>
        <button class="control-btn btn-maximize" onclick="window.api.maximize()"></button>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="nav-group">
            <div class="nav-title">Browse</div>
            <div class="nav-item active" id="navAll" onclick="applyFilter('all')">
                <span>üì¶ All Repos</span>
                <span class="nav-badge" id="countAll">0</span>
            </div>
            <div class="nav-item" id="navSource" onclick="applyFilter('source')">
                <span>‚ú® Sources</span>
                <span class="nav-badge" id="countSource">0</span>
            </div>
            <div class="nav-item" id="navFork" onclick="applyFilter('fork')">
                <span>üç¥ Forks</span>
                <span class="nav-badge" id="countFork">0</span>
            </div>
        </div>

        <div class="nav-group">
            <div class="nav-title">Actions</div>
            <div class="nav-item" onclick="startAIRename()">
                <span>ü§ñ AI Smart Rename</span>
            </div>
            <div class="nav-item" onclick="deleteSelected()" style="color: var(--danger);">
                <span>üóëÔ∏è Delete Selected</span>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="nav-item" onclick="openSettings()">
                <span>‚öôÔ∏è Settings</span>
            </div>
            <div class="nav-item" onclick="document.getElementById('helpModal').style.display='flex'">
                <span>‚ùì Help</span>
            </div>
            <div
                style="margin-top: 15px; font-size: 11px; color: #666; text-align: center; display: flex; flex-direction: column; gap: 4px; align-items: center;">
                <div style="display: flex; align-items: center; gap: 6px; opacity: 0.8;">
                    <span>Made with ‚ù§Ô∏è by <strong style="color:var(--text-primary)">palamut62</strong></span>
                    <div style="cursor: pointer; display: flex; align-items: center; transition: opacity 0.2s;"
                        onclick="window.api.openExternal('https://github.com/palamut62/github-repo-cleaner-ai')"
                        title="View Source on GitHub">
                        <svg height="16" viewBox="0 0 16 16" version="1.1" width="16" aria-hidden="true"
                            style="fill: var(--text-primary);">
                            <path
                                d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z">
                            </path>
                        </svg>
                    </div>
                </div>
                <div style="opacity: 0.5; font-size: 10px;">GitHub Repo Editor v2.0</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div class="page-title" id="pageTitle">All Repositories</div>
            <div class="search-bar">
                <div
                    style="display: flex; background: var(--bg-input); border-radius: 6px; border: 1px solid var(--border-color); margin-right: 10px;">
                    <button class="view-btn active" id="btnViewList" onclick="switchView('list')"
                        style="background:none; border:none; padding: 6px 10px; cursor: pointer; border-right: 1px solid var(--border-color);">
                        üìÑ
                    </button>
                    <button class="view-btn" id="btnViewGrid" onclick="switchView('grid')"
                        style="background:none; border:none; padding: 6px 10px; cursor: pointer;">
                        grid
                    </button>
                </div>
                <button class="btn-primary" onclick="loadRepos()">üîÑ Reload</button>
                <select class="input-dark" id="sortSelect" onchange="changeSort()">
                    <option value="newest">Newest</option>
                    <option value="oldest">Oldest</option>
                </select>
                <select class="input-dark" id="pageSizeSelect" onchange="changePageSize()">
                    <option value="10">10 / Page</option>
                    <option value="20">20 / Page</option>
                    <option value="50">50 / Page</option>
                </select>
            </div>
        </div>

        <div id="status" style="padding: 0 30px; color: var(--accent-yellow); font-size: 13px; height: 20px;"></div>

        <div id="repoGrid" class="repo-grid">
            <!-- Cards go here -->
            <div style="grid-column: 1/-1; text-align: center; margin-top: 50px; color: var(--text-secondary);">
                <h3>No Repositories Loaded</h3>
                <p>Click "Reload" to fetch your repositories.</p>
            </div>
        </div>

        <div class="footer-controls" id="paginationBar" style="display:none;">
            <button class="btn-dark" onclick="changePage(-1)">¬´ Previous</button>
            <span style="color: var(--text-secondary); font-size: 14px;" id="pageInfo">Page 1 / 1</span>
            <button class="btn-dark" onclick="changePage(1)">Next ¬ª</button>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top: 0; margin-bottom: 20px;">‚öôÔ∏è Settings</h3>
            <label>GitHub Token:</label>
            <input type="text" id="settingsToken" class="auth-input" placeholder="ghp_...">
            <label>OpenRouter Key:</label>
            <input type="text" id="settingsRouterKey" class="auth-input" placeholder="sk-or-...">
            <div style="text-align: right; gap: 10px;">
                <button class="btn-dark"
                    onclick="document.getElementById('settingsModal').style.display='none'">Cancel</button>
                <button class="btn-primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px; font-size: 13px; line-height: 1.5;">
            <h3 style="margin-top: 0; color: var(--accent-blue); font-size: 16px;">üìö User Guide</h3>

            <div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                <h4 style="margin-bottom: 5px; color: var(--text-primary);">1. Getting Started</h4>
                <p style="margin-top: 0; color: var(--text-secondary);">
                    Go to <strong>Settings</strong> ‚öôÔ∏è and enter your <strong>GitHub Token</strong>. This is required to
                    load your repositories.
                    For AI renaming, you also need an <strong>OpenRouter API Key</strong>.
                </p>

                <h4 style="margin-bottom: 5px; color: var(--text-primary);">2. Navigation & Views</h4>
                <p style="margin-top: 0; color: var(--text-secondary);">
                    Use the <strong>Sidebar</strong> to filter repositories by Source or Fork.
                    Toggle between <strong>List ‚ò∞</strong> and <strong>Grid ‚ò∑</strong> views using the buttons in the
                    top header.
                </p>

                <h4 style="margin-bottom: 5px; color: var(--text-primary);">3. Actions</h4>
                <ul style="margin-top: 0; padding-left: 20px; color: var(--text-secondary);">
                    <li><strong>Delete:</strong> Select repositories and click "Delete Selected". <strong
                            style="color:var(--danger)">Warning: This is permanent!</strong></li>
                    <li><strong>AI Smart Rename:</strong> Select repositories and click "AI Smart Rename". The AI will
                        analyze the README and suggest a proper name.</li>
                </ul>
            </div>

            <button class="btn-primary" style="width: 100%; margin-top: 20px;"
                onclick="document.getElementById('helpModal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 900px; height: 80%; display: flex; flex-direction: column;">
            <h3 style="margin: 0 0 10px 0; color: var(--accent-blue);">ü§ñ AI Suggestions</h3>
            <div
                style="flex: 1; overflow-y: auto; background: var(--bg-body); border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                <table style="width: 100%; border-collapse: collapse; color: var(--text-secondary);">
                    <thead>
                        <tr style="text-align: left; border-bottom: 1px solid var(--border-color);">
                            <th>Current</th>
                            <th>New</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="renameTableBody"></tbody>
                </table>
            </div>
            <div style="text-align: right; gap: 10px;">
                <button class="btn-dark"
                    onclick="document.getElementById('renameModal').style.display='none'">Cancel</button>
                <button id="btnExecuteRename" class="btn-primary" onclick="executeRenames()">Confirm & Rename</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalTitle">Title</h3>
            <div id="modalContent" style="margin-bottom: 20px;">Content</div>
            <button class="btn-primary"
                onclick="document.getElementById('customModal').style.display='none'">OK</button>
        </div>
    </div>

    <script>
        // State
        let allRepos = [];
        let filteredRepos = [];
        let currentFilter = 'all';
        let currentSort = 'newest';
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentView = 'list'; // Default list
        let renameProposals = [];

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            // Load Settings if needed, layout is ready
            document.getElementById('status').innerText = 'Ready. Load repos to start.';
            switchView('list'); // ensure default
        });

        // --- View Logic ---
        function switchView(mode) {
            currentView = mode;
            const grid = document.getElementById('repoGrid');
            const btnList = document.getElementById('btnViewList');
            const btnGrid = document.getElementById('btnViewGrid');

            if (mode === 'list') {
                grid.classList.add('list-view');
                btnList.style.background = 'rgba(255,255,255,0.1)';
                btnGrid.style.background = 'transparent';
                btnList.innerText = '‚ò∞';
                btnGrid.innerText = '‚ò∑';
            } else {
                grid.classList.remove('list-view');
                btnList.style.background = 'transparent';
                btnGrid.style.background = 'rgba(255,255,255,0.1)';
                btnList.innerText = '‚ò∞';
                btnGrid.innerText = '‚ò∑';
            }
        }

        function applyFilter(type) {
            currentFilter = type;
            currentPage = 1;

            // Nav Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (type === 'all') document.getElementById('navAll').classList.add('active');
            if (type === 'source') document.getElementById('navSource').classList.add('active');
            if (type === 'fork') document.getElementById('navFork').classList.add('active');

            // Title
            document.getElementById('pageTitle').innerText = type === 'all' ? 'All Repositories' : (type === 'source' ? 'Source Repositories' : 'Forked Repositories');

            // Filter Data
            if (type === 'all') filteredRepos = [...allRepos];
            else if (type === 'source') filteredRepos = allRepos.filter(r => !r.fork);
            else if (type === 'fork') filteredRepos = allRepos.filter(r => r.fork);

            sortRepos();
            renderPage();
        }

        function sortRepos() {
            filteredRepos.sort((a, b) => {
                const da = new Date(a.updated_at);
                const db = new Date(b.updated_at);
                return currentSort === 'newest' ? db - da : da - db;
            });
        }

        function changeSort() {
            currentSort = document.getElementById('sortSelect').value;
            sortRepos();
            renderPage();
        }

        function changePageSize() {
            itemsPerPage = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            renderPage();
        }

        function changePage(delta) {
            const maxPage = Math.ceil(filteredRepos.length / itemsPerPage) || 1;
            currentPage += delta;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > maxPage) currentPage = maxPage;
            renderPage();
        }

        function renderPage() {
            const grid = document.getElementById('repoGrid');
            grid.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageRepos = filteredRepos.slice(start, end);
            const total = filteredRepos.length;
            const maxPage = Math.ceil(total / itemsPerPage) || 1;

            if (pageRepos.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">No repositories found.</div>';
            } else {
                pageRepos.forEach(repo => {
                    const badge = repo.fork ? 'Fork' : 'Source';
                    const badgeClass = repo.fork ? 'badge-fork' : 'badge-source';
                    const avatar = repo.owner.avatar_url;

                    const card = document.createElement('div');
                    card.className = `repo-card ${document.getElementById('selectAll')?.checked ? 'selected' : ''}`; // Simple logic, refinement needed for individual select persistence
                    // Better selection logic: check if repo is in a 'selected' set? For now, standard checkbox.

                    card.innerHTML = `
                        <input type="checkbox" class="card-check" value="${repo.full_name}" onclick="event.stopPropagation()">
                        <div class="card-header">
                            <img src="${avatar}" class="repo-icon" alt="icon">
                            <div class="repo-details">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div class="card-title" title="${repo.name}" style="margin:0;">${repo.name}</div>
                                    <div class="badge ${badgeClass}">${badge}</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-desc" title="${repo.description || ''}">
                            ${repo.description || 'No description provided.'}
                        </div>
                        <div class="card-meta">
                            <div class="badge-star">‚≠ê ${repo.stargazers_count}</div>
                            <div>${new Date(repo.updated_at).toLocaleDateString()}</div>
                        </div>
                    `;
                    // Click card to toggle check
                    card.onclick = (e) => {
                        if (e.target.type !== 'checkbox') {
                            const chk = card.querySelector('.card-check');
                            chk.checked = !chk.checked;
                        }
                        // Visual selection state could go here
                    };

                    grid.appendChild(card);
                });
            }

            // Pagination Info
            document.getElementById('pageInfo').innerText = `Page ${currentPage} / ${maxPage}`;
            document.getElementById('paginationBar').style.display = total > 0 ? 'flex' : 'none';
        }

        // --- Data Logic ---
        async function loadRepos() {
            const token = await window.api.getToken();
            if (!token) { openSettings(); return; }

            document.getElementById('status').innerText = 'Loading...';
            const res = await window.api.getRepos(token);

            if (res.success) {
                allRepos = res.data;
                document.getElementById('status').innerText = '';

                // Update Counts
                document.getElementById('countAll').innerText = allRepos.length;
                document.getElementById('countSource').innerText = allRepos.filter(r => !r.fork).length;
                document.getElementById('countFork').innerText = allRepos.filter(r => r.fork).length;

                applyFilter(currentFilter);
            } else {
                document.getElementById('status').innerText = 'Error loading.';
                alert(res.error);
            }
        }

        async function openSettings() {
            const t = await window.api.getToken();
            const k = await window.api.getRouterKey();
            document.getElementById('settingsToken').value = t || '';
            document.getElementById('settingsRouterKey').value = k || '';
            document.getElementById('settingsModal').style.display = 'flex';
        }

        async function saveSettings() {
            const t = document.getElementById('settingsToken').value;
            const k = document.getElementById('settingsRouterKey').value;
            await window.api.saveToken(t);
            await window.api.saveRouterKey(k);
            document.getElementById('settingsModal').style.display = 'none';
            alert('Saved.');
        }

        // --- Actions ---
        function getSelected() {
            const checks = document.querySelectorAll('.card-check:checked');
            return Array.from(checks).map(c => c.value);
        }

        async function deleteSelected() {
            const selected = getSelected();
            if (selected.length === 0) return alert('Select repos first.');

            if (!confirm(`Delete ${selected.length} repos? This is PERMANENT.`)) return;

            document.getElementById('status').innerText = 'Deleting...';
            // Logic similar to previous, simplified for this rewrite view
            const token = await window.api.getToken();
            await window.api.deleteRepos({ token, repos: selected });
            document.getElementById('status').innerText = 'Deleted.';
            loadRepos(); // Refresh
        }

        async function startAIRename() {
            const selected = getSelected();
            if (selected.length === 0) return alert('Select repos first.');

            document.getElementById('status').innerText = 'Analyzing...';
            const token = await window.api.getToken();
            const routerKey = await window.api.getRouterKey();

            if (!routerKey) { alert('Add AI Key in Settings.'); openSettings(); return; }

            const results = await window.api.analyzeReposAI({ token, routerKey, repos: selected });

            renameProposals = results;
            renderRenameTable();
            document.getElementById('renameModal').style.display = 'flex';
            document.getElementById('status').innerText = '';
        }

        function renderRenameTable() {
            const tbody = document.getElementById('renameTableBody');
            tbody.innerHTML = '';
            renameProposals.forEach((p, i) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${p.currentName}</td>
                        <td><input type="text" id="prop-${i}" value="${p.proposed}" style="background:var(--bg-input); color:white; border:none; padding:4px;"></td>
                        <td id="stat-${i}">Ready</td>
                    </tr>
                 `;
            });
        }

        async function executeRenames() {
            const btn = document.getElementById('btnExecuteRename');
            btn.innerText = 'Processing...';
            const token = await window.api.getToken();

            const renames = renameProposals.map((p, i) => ({
                owner: p.original.split('/')[0],
                repo: p.currentName,
                newName: document.getElementById(`prop-${i}`).value
            }));

            const results = await window.api.executeRenames({ token, renames });

            // Show result status in table? Or just alert done.
            alert('Renames processed.');
            document.getElementById('renameModal').style.display = 'none';
            btn.innerText = 'Confirm & Rename';
            loadRepos();
        }
    </script>
</body>

</html>